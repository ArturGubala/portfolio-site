---
import Section from "./Section.astro";
import type { UiStrings } from "@types";
import type { Locale } from "@i18n/utils";

interface Props {
  ui: UiStrings;
  web3formsKey: string;
  locale: Locale;
}

const { ui, web3formsKey, locale } = Astro.props;
---

<Section text={ui.contactTitle} href="contact">
  <p class="mb-10 text-base text-neutral">{ui.contactDescription}</p>

  <form
    id="contact-form"
    method="POST"
    action="https://api.web3forms.com/submit"
    class="space-y-6"
  >
    <input type="hidden" name="access_key" value={web3formsKey} />
    <input type="hidden" name="botcheck" class="hidden" />
    <input type="hidden" name="captcha" />

    <div class="grid gap-6 sm:grid-cols-2">
      <div>
        <label for="name" class="mb-2 block text-sm font-medium text-white">
          {ui.contactNameLabel}
        </label>
        <input
          type="text"
          id="name"
          name="name"
          required
          placeholder={ui.contactNamePlaceholder}
          class="w-full rounded-lg border border-neutral/20 bg-[#1c232d] px-4 py-3 text-sm text-white placeholder:text-neutral/50 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
        />
      </div>

      <div>
        <label for="email" class="mb-2 block text-sm font-medium text-white">
          {ui.contactEmailLabel}
        </label>
        <input
          type="email"
          id="email"
          name="email"
          required
          placeholder={ui.contactEmailPlaceholder}
          class="w-full rounded-lg border border-neutral/20 bg-[#1c232d] px-4 py-3 text-sm text-white placeholder:text-neutral/50 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
        />
      </div>
    </div>

    <div>
      <label for="message" class="mb-2 block text-sm font-medium text-white">
        {ui.contactMessageLabel}
      </label>
      <textarea
        id="message"
        name="message"
        required
        rows="5"
        placeholder={ui.contactMessagePlaceholder}
        class="w-full resize-none rounded-lg border border-neutral/20 bg-[#1c232d] px-4 py-3 text-sm text-white placeholder:text-neutral/50 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
      ></textarea>
    </div>

    <button
      type="submit"
      id="contact-submit"
      class="w-full rounded-lg bg-primary px-10 py-3.5 text-sm font-medium text-[#fff] transition-opacity hover:opacity-90 disabled:opacity-50"
    >
      {ui.contactSubmitButton}
    </button>

    <div>
      <div class="h-captcha" data-captcha="true" data-theme="dark" data-hl={locale}></div>
      <div id="captcha-error" class="mt-2 hidden text-sm text-red-400">{ui.contactCaptchaError}</div>
    </div>

    <div id="contact-success" class="hidden rounded-lg bg-green-900/30 border border-green-500/30 px-4 py-3 text-sm text-green-400">
      {ui.contactSuccessMessage}
    </div>
    <div id="contact-error" class="hidden rounded-lg bg-red-900/30 border border-red-500/30 px-4 py-3 text-sm text-red-400">
      {ui.contactErrorMessage}
    </div>
  </form>
</Section>

<script src="https://web3forms.com/client/script.js" async defer></script>

<script>
  const form = document.getElementById("contact-form") as HTMLFormElement;
  const submitBtn = document.getElementById("contact-submit") as HTMLButtonElement;
  const successMsg = document.getElementById("contact-success");
  const errorMsg = document.getElementById("contact-error");
  const captchaError = document.getElementById("captcha-error");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Check if captcha has been completed
    const hcaptchaResponse = form.querySelector<HTMLTextAreaElement>(
      "[name='h-captcha-response']"
    );
    if (!hcaptchaResponse || !hcaptchaResponse.value) {
      captchaError?.classList.remove("hidden");
      return;
    }

    submitBtn.disabled = true;
    successMsg?.classList.add("hidden");
    errorMsg?.classList.add("hidden");
    captchaError?.classList.add("hidden");

    try {
      const response = await fetch(form.action, {
        method: "POST",
        body: new FormData(form),
      });

      const data = await response.json();

      if (data.success) {
        successMsg?.classList.remove("hidden");
        form.reset();
        // Reset captcha widget after successful submission
        const hcaptcha = (window as any).hcaptcha;
        if (hcaptcha) hcaptcha.reset();
      } else {
        errorMsg?.classList.remove("hidden");
      }
    } catch {
      errorMsg?.classList.remove("hidden");
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
